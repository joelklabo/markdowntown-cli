// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String          @id @default(cuid())
  githubId       String?         @unique
  username       String?
  name           String?
  email          String?         @unique
  emailVerified  DateTime?
  image          String?
  avatarUrl      String?
  accounts       Account[]
  sessions       Session[]
  sections       Snippet[]
  templates      Template[]
  documents      Document[]
  artifacts      Artifact[]
  projects       Project[]
  cliTokens      CliToken[]
  cliDeviceCodes CliDeviceCode[]
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
}

enum Visibility {
  PUBLIC
  UNLISTED
  PRIVATE
}

enum ArtifactType {
  TEMPLATE
  MODULE
  ARTIFACT
  SKILL
}

enum RunType {
  AUDIT
  SUGGEST
}

enum RunStatus {
  QUEUED
  RUNNING
  SUCCESS
  FAILED
}

enum SnapshotStatus {
  CREATED
  UPLOADING
  READY
  FAILED
}

enum PatchStatus {
  PROPOSED
  APPLIED
  REJECTED
  SUPERSEDED
}

enum AuditSeverity {
  INFO
  WARNING
  ERROR
}

enum DeviceCodeStatus {
  PENDING
  APPROVED
  DENIED
  EXPIRED
}

model Artifact {
  id          String       @id @default(cuid())
  slug        String?      @unique
  type        ArtifactType
  title       String
  description String?
  visibility  Visibility   @default(PRIVATE)
  tags        String[]     @default([])
  targets     String[]     @default([])
  hasScopes   Boolean      @default(false)
  lintGrade   String?
  views       Int          @default(0)
  copies      Int          @default(0)
  downloads   Int          @default(0)
  votesUp     Int          @default(0)
  votesDown   Int          @default(0)
  favorites   Int          @default(0)

  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  forkedFromId String?
  forkedFrom   Artifact?  @relation("ArtifactFork", fields: [forkedFromId], references: [id])
  forks        Artifact[] @relation("ArtifactFork")

  versions ArtifactVersion[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([visibility])
  @@index([type])
  @@index([tags], type: Gin)
  @@index([targets], type: Gin)
  @@index([forkedFromId])
}

model ArtifactVersion {
  id         String   @id @default(cuid())
  artifactId String
  artifact   Artifact @relation(fields: [artifactId], references: [id], onDelete: Cascade)
  version    String   @default("draft")
  uam        Json
  compiled   Json?
  lint       Json?
  message    String?
  createdAt  DateTime @default(now())

  @@index([artifactId])
}

enum SnippetKind {
  SYSTEM
  STYLE
  TOOLS
  FREEFORM
}

model Snippet {
  id             String            @id @default(cuid())
  slug           String?           @unique
  title          String
  content        String            @default("")
  order          Int               @default(0)
  visibility     Visibility        @default(PRIVATE)
  tags           String[]          @default([])
  kind           SnippetKind       @default(FREEFORM)
  views          Int               @default(0)
  copies         Int               @default(0)
  downloads      Int               @default(0)
  votesUp        Int               @default(0)
  votesDown      Int               @default(0)
  favoritesCount Int               @default(0)
  commentsCount  Int               @default(0)
  userId         String?
  user           User?             @relation(fields: [userId], references: [id])
  agentId        String?
  agent          Agent?            @relation(fields: [agentId], references: [id])
  documents      DocumentSnippet[]
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  @@index([userId])
  @@index([agentId])
  @@index([visibility])
  @@index([createdAt])
  @@index([updatedAt])
}

model Template {
  id          String     @id @default(cuid())
  slug        String     @unique
  title       String
  description String?
  body        String
  fields      Json       @default("[]")
  visibility  Visibility @default(PRIVATE)
  tags        String[]   @default([])
  views       Int        @default(0)
  copies      Int        @default(0)
  downloads   Int        @default(0)
  uses        Int        @default(0)
  userId      String?
  user        User?      @relation(fields: [userId], references: [id])
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([userId])
  @@index([visibility])
}

model Document {
  id              String            @id @default(cuid())
  slug            String            @unique
  title           String
  description     String?
  renderedContent String?
  visibility      Visibility        @default(PRIVATE)
  tags            String[]          @default([])
  views           Int               @default(0)
  copies          Int               @default(0)
  downloads       Int               @default(0)
  userId          String?
  user            User?             @relation(fields: [userId], references: [id])
  snippets        DocumentSnippet[]
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([userId])
  @@index([visibility])
}

model DocumentSnippet {
  documentId String
  snippetId  String
  position   Int
  overrides  Json?
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  snippet    Snippet  @relation(fields: [snippetId], references: [id], onDelete: Cascade)

  @@id([documentId, position])
  @@index([snippetId])
}

model Project {
  id          String     @id @default(cuid())
  name        String
  slug        String?
  provider    String?
  description String?
  userId      String
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  snapshots   Snapshot[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([userId])
  @@index([slug])
  @@index([provider])
}

model Snapshot {
  id               String         @id @default(cuid())
  projectId        String
  project          Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  baseSnapshotId   String?
  baseSnapshot     Snapshot?      @relation("SnapshotBase", fields: [baseSnapshotId], references: [id], onDelete: SetNull)
  derivedSnapshots Snapshot[]     @relation("SnapshotBase")
  source           String?
  repoRoot         String?
  manifestHash     String?
  protocolVersion  String?
  idempotencyKey   String?
  status           SnapshotStatus @default(CREATED)
  metadata         Json?
  files            SnapshotFile[]
  runs             Run[]
  auditIssues      AuditIssue[]
  patches          Patch[]
  workspaces       Workspace[]
  finalizedAt      DateTime?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  @@unique([projectId, idempotencyKey])
  @@index([projectId])
  @@index([baseSnapshotId])
  @@index([manifestHash])
}

model Workspace {
  id         String              @id @default(cuid())
  snapshotId String
  snapshot   Snapshot            @relation(fields: [snapshotId], references: [id], onDelete: Cascade)
  edits      WorkspaceFileEdit[]
  runs       Run[]
  createdAt  DateTime            @default(now())
  updatedAt  DateTime            @updatedAt

  @@index([snapshotId])
}

model WorkspaceFileEdit {
  id          String    @id @default(cuid())
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  path        String
  content     String
  hash        String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([workspaceId, path])
  @@index([workspaceId])
}

model SnapshotFile {
  id          String    @id @default(cuid())
  snapshotId  String
  snapshot    Snapshot  @relation(fields: [snapshotId], references: [id], onDelete: Cascade)
  path        String
  blobId      String
  blob        Blob      @relation(fields: [blobId], references: [id])
  sizeBytes   Int
  contentType String?
  isBinary    Boolean   @default(false)
  mode        Int?
  mtime       DateTime?
  orderIndex  Int       @default(0)
  isDeleted   Boolean   @default(false)
  deletedAt   DateTime?
  createdAt   DateTime  @default(now())

  @@unique([snapshotId, path])
  @@index([snapshotId])
  @@index([snapshotId, isDeleted])
  @@index([snapshotId, orderIndex])
  @@index([blobId])
}

model Blob {
  id            String         @id @default(cuid())
  sha256        String         @unique
  sizeBytes     Int
  content       Bytes?
  storageKey    String?
  createdAt     DateTime       @default(now())
  snapshotFiles SnapshotFile[]
}

model Run {
  id         String    @id @default(cuid())
  snapshotId String
  snapshot   Snapshot  @relation(fields: [snapshotId], references: [id], onDelete: Cascade)
  workspaceId String?
  workspace   Workspace? @relation(fields: [workspaceId], references: [id], onDelete: SetNull)
  type       RunType
  status     RunStatus @default(QUEUED)
  input      Json?
  output     Json?
  error      String?
  createdAt  DateTime  @default(now())
  startedAt  DateTime?
  finishedAt DateTime?

  @@index([snapshotId])
  @@index([workspaceId])
  @@index([type])
  @@index([status])
}

model Patch {
  id             String      @id @default(cuid())
  snapshotId     String
  snapshot       Snapshot    @relation(fields: [snapshotId], references: [id], onDelete: Cascade)
  path           String
  baseBlobHash   String
  patchFormat    String
  patchBody      String
  status         PatchStatus @default(PROPOSED)
  idempotencyKey String?
  createdAt      DateTime    @default(now())
  appliedAt      DateTime?

  @@unique([snapshotId, idempotencyKey])
  @@index([snapshotId])
  @@index([snapshotId, status])
  @@index([snapshotId, path])
}

model AuditIssue {
  id         String        @id @default(cuid())
  snapshotId String
  snapshot   Snapshot      @relation(fields: [snapshotId], references: [id], onDelete: Cascade)
  ruleId     String
  severity   AuditSeverity
  path       String
  message    String
  createdAt  DateTime      @default(now())

  @@index([snapshotId])
  @@index([severity])
  @@index([ruleId])
}

model CliToken {
  id         String    @id @default(cuid())
  userId     String
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokenHash  String    @unique
  scopes     String[]  @default([])
  label      String?
  lastUsedAt DateTime?
  revokedAt  DateTime?
  expiresAt  DateTime?
  createdAt  DateTime  @default(now())

  @@index([userId])
  @@index([revokedAt])
}

model CliDeviceCode {
  id              String           @id @default(cuid())
  deviceCodeHash  String           @unique
  userCodeHash    String           @unique
  status          DeviceCodeStatus @default(PENDING)
  userId          String?
  user            User?            @relation(fields: [userId], references: [id], onDelete: SetNull)
  clientId        String?
  deviceName      String?
  scopes          String[]         @default([])
  intervalSeconds Int              @default(5)
  expiresAt       DateTime
  confirmedAt     DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([userId])
  @@index([status])
  @@index([expiresAt])
}

model Agent {
  id          String    @id @default(cuid())
  name        String
  description String?
  config      String?
  sections    Snippet[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}
