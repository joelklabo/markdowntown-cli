#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
BIN_DIR="${BIN_DIR:-${ROOT}/bin}"
BIN_PATH="${BIN_DIR}/markdowntown"
EXT_DIR="${ROOT}/vscode-extension"
CODE_BIN_EXPLICIT=0
if [ -n "${CODE_BIN:-}" ]; then
  CODE_BIN_EXPLICIT=1
fi
CODE_BIN="${CODE_BIN:-code}"

DRY_RUN=0
SKIP_BUILD=0
SKIP_INSTALL=0

usage() {
  cat <<'EOF'
Usage: scripts/lsp-vscode [--dry-run] [--skip-build] [--skip-install]

Builds the markdowntown CLI + VS Code extension, then launches VS Code with the
extension in development mode.

Environment:
  BIN_DIR  Override output directory for the CLI binary (default: ./bin)
EOF
}

for arg in "$@"; do
  case "$arg" in
    --dry-run|-n)
      DRY_RUN=1
      ;;
    --skip-build)
      SKIP_BUILD=1
      ;;
    --skip-install)
      SKIP_INSTALL=1
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      echo "Unknown option: $arg" >&2
      usage >&2
      exit 1
      ;;
  esac
done

if [ "$DRY_RUN" -eq 1 ]; then
  echo "ROOT=${ROOT}"
  echo "BIN_PATH=${BIN_PATH}"
  echo "EXT_DIR=${EXT_DIR}"
  echo "CODE_CMD=${CODE_BIN} --extensionDevelopmentPath=\"${EXT_DIR}\" --new-window \"${ROOT}\""
  exit 0
fi

if [ "$SKIP_BUILD" -eq 0 ]; then
  mkdir -p "${BIN_DIR}"
  (cd "${ROOT}" && go build -o "${BIN_PATH}" ./cmd/markdowntown)
fi

if [ "$SKIP_INSTALL" -eq 0 ] && [ ! -d "${EXT_DIR}/node_modules" ]; then
  (cd "${EXT_DIR}" && npm install)
fi

if [ "$SKIP_BUILD" -eq 0 ]; then
  (cd "${EXT_DIR}" && npm run build)
fi

if [ "$CODE_BIN_EXPLICIT" -eq 0 ]; then
  if command -v code >/dev/null 2>&1; then
    CODE_BIN="code"
  elif command -v code-insiders >/dev/null 2>&1; then
    CODE_BIN="code-insiders"
  else
    echo "VS Code CLI not found. Install it via VS Code: Cmd+Shift+P -> 'Shell Command: Install \\'code\\' command in PATH' (or set CODE_BIN=code-insiders)." >&2
    exit 1
  fi
else
  if ! command -v "$CODE_BIN" >/dev/null 2>&1; then
    echo "VS Code CLI '${CODE_BIN}' not found in PATH." >&2
    exit 1
  fi
fi

PATH="${BIN_DIR}:${PATH}" "$CODE_BIN" --extensionDevelopmentPath="${EXT_DIR}" --new-window "${ROOT}"
